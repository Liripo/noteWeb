<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Liripo" />


<title>R 元编程学习</title>

<script src="site_libs/header-attrs-2.9/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link href="site_libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
<script src="site_libs/bs3compat-0.2.5.1/tabs.js"></script>
<script src="site_libs/bs3compat-0.2.5.1/bs3compat.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">noteWeb</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="R-metaprogramming.html">R</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">R 元编程学习</h1>
<h4 class="author">Liripo</h4>
<h4 class="date">2021/10/28</h4>

</div>


<div id="r-元编程metaprogramming笔记" class="section level1">
<h1>R 元编程（<strong>metaprogramming</strong>）笔记</h1>
<blockquote>
<p>元编程概念：编写运行时动态修改程序本身的代码（编写产生代码的代码）【使用编程语言来操作或修改自己的代码,代码就是数据】</p>
</blockquote>
<p>R中进行元编程的操作可以使用<code>base R</code>中的函数，也可以使用<code>rlang</code>函数【tidyverse用的就是这个】，当然，<code>data.table</code>也有自己的元编程。</p>
<p>通过操作命令与执行环境，操作自己的代码</p>
<div id="base-r" class="section level2">
<h2>base R</h2>
<div id="call函数" class="section level3">
<h3>call函数</h3>
<p>call函数构建一个命令（<strong>function call</strong>），其第一个参数必须是一个字符串，指明需要被构建的命令，其余参数都会被传递给新生成的命令。</p>
<pre class="r"><code>cl &lt;- call(&quot;round&quot;,1.11)
cl
## round(1.11)
class(cl);typeof(cl)
## [1] &quot;call&quot;
## [1] &quot;language&quot;
identical(cl,quote(round(1.11)))
## [1] TRUE
is.call(cl) &amp;&amp; is.language(cl)
## [1] TRUE
eval(cl)
## [1] 1
(cl_list &lt;- as.list(cl))
## [[1]]
## round
## 
## [[2]]
## [1] 1.11
as.call(cl_list)
## round(1.11)
mode(cl_list) &lt;- &quot;call&quot;;cl_list
## round(1.11)</code></pre>
<p><code>do.call(what, args, quote = FALSE, envir = parent.frame())</code>命令则是直接在<code>envir</code>中执行<code>call</code>命令。</p>
</div>
<div id="捕获代码" class="section level3">
<h3>捕获代码</h3>
<p><code>quote(expr)</code>函数捕获未执行的代码。<code>enquote(cl)</code>捕获代码的运行结果,cl为<code>call</code>对象。</p>
<pre class="r"><code>quote(1:9 + 2)
## 1:9 + 2
enquote(1:9 + 2)
## base::quote(c(3, 4, 5, 6, 7, 8, 9, 10, 11))</code></pre>
<p>如果希望捕获代码中，某些变量名被替换为对应的值，可以使用<code>substitute(expr, env)</code>,<strong><code>substitute</code></strong>函数除了需要捕获的代码，还可以传递一个替换环境<strong>env</strong>（可以是<code>列表</code>、<code>数据框</code>、<code>执行环境</code>等）参数，此时代码中的变量名如果在<strong>env</strong>中有对应的值，则会被替换为相应的值，除非<strong>env</strong>是全局执行环境。</p>
<p>如果只希望特定的变量名可以被替换，而非所有在执行环境中存在的变量都会被替换，则可以使用<code>bquote</code>函数，该函数定义了一种特殊的语法格式——所有被包含在<strong><code>.()</code></strong>中的变量名才会被替换。</p>
<pre class="r"><code>substitute(a + b, list(b = 1))
## a + 1
substitute(a + b, baseenv())
## .Primitive(&quot;+&quot;)(a, b)
b &lt;- 1;substitute(a + b, globalenv())
## a + b
bquote(x &lt;- .(x) + 1, list(x = 1:9))
## x &lt;- 1:9 + 1</code></pre>
</div>
<div id="eval执行代码" class="section level3">
<h3>eval执行代码</h3>
<p><code>eval(expr, envir, enclos)</code>执行捕获的代码，其中<strong>envir</strong>是代码中变量名的首要查找位置，<strong>envir</strong>中查找不到的变量名会在<strong>enclos</strong>中查找。</p>
<p>在指定的环境中计算R表达式。</p>
<pre class="r"><code>在指定的环境中计算R表达式
## Error in eval(expr, envir, enclos): object &#39;在指定的环境中计算R表达式&#39; not found
#local函数默认情况下会在一个临时执行环境中执行代码，可以有效的舍弃运算过程中产生的中间变量，返回最后一行表达式，类似函数。
local({
  a &lt;- 1:9;
  b &lt;- a
},envir = new.env())
a;b
## Error in eval(expr, envir, enclos): object &#39;a&#39; not found
## [1] 1</code></pre>
<p>由操作符<code>~</code>构成的命令，被捕获或执行后结果是一致的，唯一的区别在于<strong>～</strong>被捕获后产生的结果没有属性（<strong>attributes</strong>）部分，但无论何种情况我们可以像操作命令树一样取出<strong>~</strong>前后的内容，所以<strong><code>~</code></strong>经常被用作捕获代码的便捷操作符号。</p>
<pre class="r"><code>str(eval(y~x))
## Class &#39;formula&#39;  language y ~ x
##   ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;
str(quote(y~x))
##  language y ~ x</code></pre>
<pre class="r"><code>knitr::include_graphics(&quot;./images/rmetaprogramming.svg&quot;)</code></pre>
<p><img src="images/rmetaprogramming.svg" /><!-- --></p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
